أنت تعمل على مشروع K9 (Flask) موجود بالفعل. المطلوب تنفيذ تعديل كبير “منطق استخدام + إدارة حسابات + نظام صلاحيات مرن” بين 3 أدوار:
- HANDLER (السائس)
- PROJECT_MANAGER (مسؤول المشروع)
- GENERAL_ADMIN (المدير العام)

قيود صارمة (Mandatory):
1) ممنوع إنشاء صفحات/شاشات جديدة من الصفر. استخدم الشاشات الحالية فقط، وعدّل داخلها (templates/routes/services) حسب الحاجة.
2) لا تغيّر أنظمة الأمن (MFA/CSRF/تشفير…). لا توسع بهذا الجانب.
3) لا تبني نظام صلاحيات ثالث جديد. يوجد بالمشروع نظام مفاتيح وصلاحيات (Permission keys + Role mapping + user grants). استعمل الموجود وطوره.
4) مسموح إضافة “قسم صغير” داخل صفحة موجودة (مثل: تبويب/Box/قائمة صلاحيات) بشرط أنها داخل نفس صفحة إدارة المستخدم الموجودة حاليًا (وليس صفحة جديدة).

=================================================================
المطلوب رقم (1): نموذج الصلاحيات النهائي (أفضل ممارسة للنظام)
=================================================================
نفّذ نموذج Hybrid:
A) Role Baseline Permissions (RBAC):
- كل دور له مجموعة صلاحيات افتراضية (Baseline).
- GENERAL_ADMIN baseline = كل شيء.

B) Permission Keys:
- كل شاشة/ميزة/عملية في النظام يجب أن تُحكم بـ permission keys بصيغة module.action مثل:
  dogs.view / dogs.create / dogs.edit / dogs.delete
  schedule.view / schedule.create / schedule.edit / schedule.lock
  shift_report.create / shift_report.submit / shift_report.edit
- إذا يوجد بالفعل Keys بالمشروع بنفس الفكرة، التزم بها ولا تختلق naming جديد.
- إذا كان هناك أجزاء من النظام بدون keys مقابلها: أضف أقل عدد ممكن من keys وبنفس النمط الحالي.

C) User-Specific Overrides (هذا هو قلب الطلب):
- المدير العام GENERAL_ADMIN يستطيع منح صلاحيات إضافية (permission keys) لمستخدم محدد (PM أو Handler) فوق baseline.
- هذه الإضافات يجب أن تؤثر فورًا على:
  1) الوصول للـ endpoints (Backend)
  2) ظهور روابط القوائم/الأزرار في الواجهة (Frontend templates)
- آلية التحقق من الصلاحية MUST تكون:
  effective_permissions(user) = baseline(role) + user_overrides(grants) - user_overrides(revokes إن كانت موجودة)
- إذا النظام الحالي يحتوي “grant فقط” بدون revoke، نفّذ grant فقط كبداية (ولا تخترع revoke إذا غير موجود).

D) Project Scope:
- PM و Handler يجب أن تكون صلاحياتهم محصورة بمشروعهم (Team Scope) في عرض البيانات وإدارتها.
- GENERAL_ADMIN يرى كل المشاريع وكل البيانات.
- إذا كانت هناك جداول/علاقات تعيين المستخدم للمشروع موجودة بالفعل، استعملها لتحديد scope.
- لا تنشئ مفهوم جديد للتعيين إن كان موجودًا.

=================================================================
المطلوب رقم (2): إدارة المستخدمين والحسابات + الصلاحيات من داخل نفس الشاشات الحالية
=================================================================
1) GENERAL_ADMIN:
- إدارة كاملة للمستخدمين: إنشاء/تعديل/تفعيل/تعطيل/تعيين لمشروع.
- إدارة الصلاحيات:
  - baseline بالدور
  - وإضافة Overrides لكل مستخدم (PM/Handler)

2) PROJECT_MANAGER:
- لا ينشئ حسابات جديدة من الصفر (إلا إذا هذه الوظيفة موجودة حاليًا، وإن كانت موجودة فلتكن ضمن مشروعه فقط).
- يدير فريق مشروعه تشغيليًا (الجداول/التوزيعات/المراجعات).

3) HANDLER:
- لا يصل لإدارة المستخدمين.

UI المطلوب (بدون صفحات جديدة):
- ابحث عن صفحة “تعديل/تفاصيل المستخدم” الموجودة حاليًا في النظام (User management screen).
- داخل نفس الصفحة أضف قسم واضح بعنوان:
  “صلاحيات إضافية للمستخدم (Overrides)”
- هذا القسم يظهر فقط للـ GENERAL_ADMIN.
- يحتوي قائمة بالصلاحيات/المفاتيح الموجودة (مقسمة حسب category/module إن كان هذا موجودًا).
- يسمح بتحديد permissions إضافية (checkboxes) ثم حفظ.
- عند الحفظ: تُحدث منح الصلاحيات في قاعدة البيانات وتنعكس فورًا.

ملاحظة مهمة:
- لا تنشئ صفحة جديدة لإدارة الصلاحيات.
- لا تنشئ sidebar جديد كامل. فقط اجعل القوائم الحالية تستجيب لeffective_permissions.

=================================================================
المطلوب رقم (3): التحضير اليومي PM-only
=================================================================
منطق تشغيل إلزامي:
- التحضير اليومي (Daily Schedule) يقوم به PM (أو GENERAL_ADMIN) فقط.
- السائس لا يحضّر لنفسه أبدًا.

تنفيذ على الموجود:
- حدد endpoints/صفحات إنشاء وتعديل DailySchedule/DailyScheduleItem.
- اسمح بها للـ PM + GENERAL_ADMIN.
- امنعها عن HANDLER.
- HANDLER يستطيع فقط:
  - رؤية جدوله/عناصره
  - وتحديث حالة التنفيذ ضمن عناصره إن كان هذا موجودًا أصلًا.

UI:
- إذا كان لدى السائس روابط تؤدي لإنشاء جدول/تحضير: أخفها عن السائس (بدون حذف الصفحات).

=================================================================
المطلوب رقم (4): تقرير الوردية Shift Report إلزامي 100%
=================================================================
منطق تشغيل إلزامي:
- تقرير الوردية (Shift Report) ليس اختياري.
- يجب تعبئته عند نهاية كل وردية تم تحضيرها من PM.

تنفيذ بدون صفحات جديدة:
- استخدم شاشة/مسار Shift Report الموجودة بالفعل.
- أضف Guards في التدفق الحالي:

Option A (مفضل):
- عند دخول السائس للـ dashboard/صفحة اليوم:
  إذا لديه وردية منتهية/قابلة للإغلاق ولا يوجد Shift Report مربوط بها:
  - اعرض تنبيه واضح داخل نفس الصفحة
  - وزر ينقله مباشرة إلى شاشة التقرير الموجودة
  - ويمكن منع الوصول لباقي أجزاء التشغيل حتى يرسل التقرير (إذا هذا متوافق مع منطق النظام الحالي).

Option B:
- عند محاولة “إنهاء وردية/إغلاق” (إذا موجود):
  لا تسمح بالإغلاق إلا إذا يوجد تقرير وردية.

لا تختلق مفاهيم جديدة. اربط الإلزام بالكيانات الموجودة: Shift / ScheduleItem / ShiftReport أو ما يعادلها بالمشروع.

=================================================================
المطلوب رقم (5): GENERAL_ADMIN يستطيع الإدخال في كل الشاشات
=================================================================
- GENERAL_ADMIN يجب أن يكون قادرًا على Add/Edit/Delete/View داخل كل الشاشات الموجودة.
- إذا كان هناك أي endpoint يمنع GENERAL_ADMIN من CRUD، عدله بحيث يسمح له.
- مع الإبقاء أن PM و Handler لهم Scope محدود.

=================================================================
المطلوب رقم (6): ظهور الصلاحيات فورًا في واجهات المستخدم
=================================================================
- أي مكان في templates أو navbar أو buttons يعتمد على صلاحية:
  اجعله يعتمد على effective_permissions(user) وليس role فقط.
- عند منح Override لمستخدم:
  تظهر الروابط/الأزرار فورًا عند تسجيل دخوله أو تحديث الصفحة (بدون إعادة تشغيل السيرفر).

=================================================================
معايير القبول النهائية (Acceptance Criteria)
=================================================================
1) PM ينشئ التحضير اليومي لفريقه مسبقًا.
2) HANDLER يرى جدول تحضيره ولا يستطيع إنشاء التحضير.
3) Shift Report إلزامي: لا يمكن تجاوز نهاية الوردية بدون تقرير.
4) GENERAL_ADMIN:
   - CRUD كامل بكل الشاشات
   - إدارة المستخدمين
   - منح Overrides لمستخدم محدد (PM/Handler) لصلاحيات أي شاشة/فرع/عملية
5) عند منح Overrides تظهر فورًا في UI وفي صلاحيات backend.
6) لا توجد صفحات جديدة تم إنشاؤها من الصفر.

=================================================================
مخرجات مطلوبة منك
=================================================================
- نفّذ بأقل تغيير ممكن.
- قدم ملخصًا في النهاية:
  - ما الملفات التي عدلتها ولماذا
  - أين أضفت قسم overrides داخل صفحة إدارة المستخدم الموجودة
  - كيف حسبت effective_permissions
  - أين فرضت إلزام Shift Report
  - أين قيدت التحضير ليكون PM-only
