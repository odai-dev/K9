الغرض: استكمال منطق مراجعة التقارير ليشمل اعتماد الإدارة العامة، وتوحيد حالات التقارير، وإلغاء مسارات الموافقة القديمة.

المهام المطلوب تنفيذها:

توسيع تعداد حالات التقارير (ReportStatus):

أضِف حالتين جديدتين للتعداد في ملف models_handler_daily.py:

APPROVED_BY_ADMIN (معتمد من الإدارة العامة).

REJECTED_BY_ADMIN (مرفوض من الإدارة العامة).

حدِّث أي قيود أو فهارس مرتبطة بالحالة لتشمل هذه القيم.

إنشاء خدمات للمراجعة النهائية في الإدارة العامة:

ضمن report_review_service.py أضِف دوال جديدة مثل:

admin_approve(report_type, report_id, admin_user_id, notes=None)
تحول حالة التقرير من FORWARDED_TO_ADMIN إلى APPROVED_BY_ADMIN، وتُسجّل عملية المراجعة في جدول ReportReview، مع إضافة ملاحظات إن وجدت.

admin_reject(report_type, report_id, admin_user_id, reason)
تحول حالة التقرير من FORWARDED_TO_ADMIN إلى REJECTED_BY_ADMIN، وتُسجّل السبب، مع سجل مراجعة (audit log).

هذه الدوال يجب أن تتأكد من أنّ المستخدم الذي يقوم بالعملية يحمل دور GENERAL_ADMIN.

أضِف إخطارات مناسبة تُرسل للسائس ومدير المشروع عند اعتماد أو رفض التقرير من الإدارة العامة باستخدام NotificationService (على سبيل المثال: نوع إشعار REPORT_APPROVED أو REPORT_REJECTED مع عنوان ورسالة واضحة).

إضافة مسارات للإدارة العامة:

أنشئ مسارات جديدة في ملف مناسب (مثل admin_routes.py أو supervisor_routes.py) للسماح للمدير العام بالاطلاع على قائمة التقارير ذات الحالة FORWARDED_TO_ADMIN لكل نوع تقرير.

مثال: @admin_bp.route('/reports/pending', methods=['GET']) يعرض كافة التقارير المحولة.

أضِف مسارات لتنفيذ الاعتماد أو الرفض النهائي للتقرير:

@admin_bp.route('/reports/<report_type>/<report_id>/approve', methods=['POST']) يستدعي الخدمة admin_approve.

@admin_bp.route('/reports/<report_type>/<report_id>/reject', methods=['POST']) يستدعي الخدمة admin_reject.

هذه المسارات يجب أن تكون محمية بصلاحية GENERAL_ADMIN فقط.

تحديث واجهة المستخدم:

أضِف صفحة في لوحة الإدارة العامة لعرض “التقارير بانتظار الموافقة” مع تفاصيل مختصرة (التاريخ، السائس، المشروع، نوع التقرير).

في الصفحة، وفر أزرار “اعتماد” و“رفض” لكل تقرير، مع حقل ملاحظات اختياري عند الاعتماد وحقل سبب إجباري عند الرفض.

استخدم AJAX أو استدعاءات API الموجودة لديك لتمرير الطلبات إلى المسارات التي تنشئها في الخطوة 3.

التنظيف والتوحيد:

أزل أو عطّل الدوال القديمة في pm_routes.py التي تقوم بالموافقة المباشرة (approve_report, reject_report) لأن منطقها لا يمر بمرحلة الإدارة العامة.

تأكد من أن قائمة التقارير المعلّقة في لوحة مدير المشروع تستعرض فقط التقارير ذات الحالة SUBMITTED وأن زر “اعتماد” أصبح ينادي المسار الجديد الذي يحول الحالة إلى FORWARDED_TO_ADMIN.

حدّث أي إشارات إلى الحالة APPROVED في الواجهات لتعرض الحالات الجديدة (APPROVED_BY_PM, FORWARDED_TO_ADMIN, APPROVED_BY_ADMIN, إلخ).

اختبار شامل:

حدِّث اختبارات الوحدة أو اكتب اختبارات جديدة للتحقق من:

عدم قدرة مدير المشروع على تنفيذ مراجعة نهائية أو مراجعة تقاريره الخاصة.

قدرة المدير العام فقط على اعتماد أو رفض التقارير المحوّلة.

إرسال الإشعارات الصحيحة لجميع الأطراف (السائس، مدير المشروع، الإدارة) في كل حالة.

التذكير: التزم ببنية المشروع الحالية وطبقة الخدمات الموجودة، ولا تستحدث ملفات خارج التسلسل إلا إذا كان ضرورياً. لا تنسَ تحديث ملف الهجرات (alembic أو الملف المعادل) لإضافة الحالات الجديدة وتعديل الجداول ذات الصلة.