توحيد واجهات الموافقة وتصدير التقارير

الغرض: استكمال التعديلات اللازمة لضمان انسجام الواجهات مع آلية الموافقة الجديدة، وإضافة القدرة على تنزيل جميع التقارير بصيغتي PDF و Excel لكل من مدير المشروع والإدارة العامة.

المهام المطلوب تنفيذها:

توحيد واجهات مدير المشروع:

تحديث قالب pm/pending_approvals.html وأي صفحات مشابهة بحيث تستعمل المسارات الجديدة (/api/pm/reports/<report_type>/<report_id>/approve, .../request-edits, .../reject) بدلاً من المسارات القديمة (approve_report, reject_report) التي تم تعليمها كـ DEPRECATED.

تحديث شريط الحالة في الواجهات لعرض الحالات الجديدة (APPROVED_BY_PM, FORWARDED_TO_ADMIN, APPROVED_BY_ADMIN, REJECTED_BY_PM, REJECTED_BY_ADMIN) بدلاً من الحالات القديمة (APPROVED, REJECTED).

التأكد من أن الصفحات الخاصة بالإحصائيات والعدادات (مثل “التقارير بانتظار الموافقة”) تستخدم الحالة الصحيحة (SUBMITTED للقيد عند مدير المشروع، وFORWARDED_TO_ADMIN عند الإدارة العامة).

إضافة/تحسين تصدير التقارير (PDF و Excel):

لكل من تقارير السائس (HandlerReport) وتقارير الوردية (ShiftReport) وأية تقارير أخرى قابلة للمراجعة:

إضافة خدمة توليد PDF يستخدم مكتبة مثل WeasyPrint أو wkhtmltopdf لعرض التقرير بصيغة PDF مطابقة للتصميم الحالي.

إضافة خدمة تصدير إلى Excel باستخدام مكتبة مثل pandas أو openpyxl، بحيث يتضمن ملف الـ Excel جميع حقول التقرير والأقسام الفرعية.

إنشاء مسارات في pm_routes.py وadmin_routes.py تتيح لمدير المشروع والإدارة العامة تنزيل تقرير واحد بصيغة PDF أو Excel.
مثال: /pm/reports/<report_id>/download/pdf و/pm/reports/<report_id>/download/excel، مع نسخ موازية تحت /admin/....

تقييد هذه المسارات بحيث لا يستطيع السائس العادي الوصول إليها، وإنما فقط صاحب الدور المناسب (PROJECT_MANAGER أو GENERAL_ADMIN).

إضافة أزرار “تحميل PDF” و“تحميل Excel” في صفحات عرض التقرير (handler_daily/report_view.html, shift_report_view.html, وأية صفحات معنية) وفي صفحة مراجعة التقارير للمشروع والإدارة.

اختبار عملي للتأكد من أن الملفات المصدّرة تُفتح بشكل صحيح وتتضمن كل البيانات وأن الصلاحيات مطبَّقة.

مراجعة شاملة للوظائف الجديدة:

التأكد من أن عملية الموافقة النهائية (اعتماد أو رفض من الإدارة العامة) تُزيل التقارير من قائمة الانتظار وتحدّث الإحصائيات في الشريط العلوي.

التأكد من إرسال الإشعارات المناسبة بعد الاعتماد أو الرفض النهائي، سواء للسائس أو لمدير المشروع.

إزالة أو تعطيل أي مسارات قديمة أو قوالب لم تعد متوافقة مع النظام الجديد، لمنع الارتباك.

التنفيذ المرحلي: نظرًا لقيود الخطة المجانية، يمكن البدء بالنقطة الأولى (توحيد الواجهات) ثم رفع التغييرات، يليها تنفيذ تصدير التقارير PDF/Excel في جلسة تالية إذا لزم الأمر. بعد كل مرحلة، تأكد من رفع الملفات إلى GitHub ومشاركة التغييرات معنا لمراجعتها.