أريد منك الآن تنفيذ إصلاح أساسي في نظام الصلاحيات بحيث يعمل بصورة صحيحة وكاملة، وهذه هي المتطلبات الدقيقة:

الهدف العام

أريد أن يصبح ظهور جميع الشاشات في النظام مبنيًا فقط على نظام الصلاحيات (permissions) وليس على الأدوار (roles).

بالإضافة إلى ذلك، كل دور في النظام يجب أن يحصل تلقائيًا على مجموعة “صلاحيات أساسية” يتم تطبيقها عند إنشاء الحساب، وبعد ذلك المدير العام يستطيع إضافة أو إزالة صلاحيات إضافية لهذا الحساب.

أولًا — إصلاح ظهور الشاشات (Menu Visibility)

يجب إزالة أي شرط في القوالب (templates) يعتمد على الدور مثل:

{% if current_user.role == 'GENERAL_ADMIN' %}


أو أي شرط مشابه.

واستبداله بالكامل بشيء واحد فقط:

{% if has_permission(current_user, 'permission.code.here') %}


معنى ذلك:

لا يظهر أي عنصر في القائمة إلا إذا كان للمستخدم صلاحية هذه الشاشة.

كل صفحة في النظام يجب ربطها بصلاحية واضحة في permissions_map.json.

كل مسؤول مشروع أو سائس أو أي دور آخر لن يرى إلا الشاشات التي يملكها فعلاً.

المدير العام دائمًا يملك كل الصلاحيات تلقائيًا.

ثانيًا — إضافة “صلاحيات أساسية تلقائية” لكل دور عند إنشاء الحساب

عند إنشاء حساب جديد لأي دور يجب أن يتم إعطاؤه صلاحيات أساسية مناسبة له تلقائيًا بدون تدخل المدير العام.

مثال:

صلاحيات السائس (Handler) الأساسية

handler.dashboard.view

handler.schedule.view

handler.reports.daily.create

handler.reports.period.create

handler.dog.view

handler.notifications.view

صلاحيات مسؤول المشروع (Project Manager) الأساسية

pm.dashboard.view

pm.schedule.manage

pm.reports.review

pm.handlers.view

pm.dogs.view

pm.daily_reports.view

صلاحيات المدير العام (General Admin) الأساسية

يحصل على جميع الصلاحيات تلقائيًا

هذه الصلاحيات الأساسية يجب أن:

تُضاف تلقائيًا عند إنشاء الحساب

وتظهر في صفحة إدارة الصلاحيات بوضع ON

ولا يمكن حذفها من المدير العام

ثالثًا — ربط كل شاشة في النظام بصلاحية

كل صفحة لها صلاحية خاصة بها مثل:

admin.accounts.view

admin.permissions.manage

admin.projects.manage

pm.schedule.manage

handler.schedule.view

dogs.management.create

dogs.management.view

dogs.management.update

يجب التأكد أن كل شاشة في النظام:

لها صلاحية واضحة داخل permissions_map.json

مربوطة بظهورها داخل القوالب عبر has_permission()

مربوطة بحماية الـ routes عبر has_permission()

رابعًا — تحسين صفحة إدارة الصلاحيات

في صفحة إدارة الصلاحيات:

يجب أن تظهر كل الصلاحيات بشكل مفهوم (ليست حروفًا مختصرة).

كل صلاحية أساسية تظهر بأنها “أساسية” ولا يمكن إطفاؤها.

كل صلاحية إضافية يستطيع المدير العام تشغيلها أو إطفاءها بحرية.

ظهور الواجهة يجب أن يعكس الوضع الحقيقي للمستخدم.

خامسًا — ممنوع إعادة بناء النظام أو إجراء Refactor كبير

فقط:

وصل الشاشات بنظام الصلاحيات

تأكد أن الأدوار تأخذ صلاحياتها الأساسية تلقائيًا

وتأكد أن الواجهة تظهر بناءً على الصلاحيات فقط

لا تغيّر أي شيء آخر خارج هذه النقاط.

بعد الانتهاء

قم بفحص أن كل الشاشات تظهر أو تختفي بشكل صحيح لكل دور.

قم بتسجيل الدخول كمدير عام وتأكد أن كل شيء ظاهر.

ثم قم بتسجيل الدخول كمسؤول مشروع وسائس للتأكد أن الشاشات الأساسية تظهر لهم.

هذا كل شيء. نفّذ المطلوب خطوة بخطوة وطبّقه مباشرة على ملفات المشروع دون أي خطوة إضافية.

ابدأ التنفيذ الآن.