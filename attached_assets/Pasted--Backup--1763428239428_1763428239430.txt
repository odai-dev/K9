أريد منك تحديث نظام النسخ الاحتياطي في المشروع (بدون إضافة أي صفحة جديدة) ليصبح نظام Backup متقدّم ومرن يدعم:

Google Drive

Dropbox

ربط تلقائي Auto-OAuth

عرض مساحة التخزين المستخدمة والمتبقية في كل خدمة

والرفع والاسترجاع عبر أي مزود أو كليهما

كل التعديلات يجب أن تكون داخل "صفحة النسخ الاحتياطي الحالية فقط" بدون بناء صفحة جديدة.

1 – نظام الربط التلقائي Auto-Linking

عند الضغط على:

“نسخ احتياطي Google Drive”

“نسخ احتياطي Dropbox”

“استرجاع Google Drive”

“استرجاع Dropbox”

إذا لم يكن المستخدم مربوطًا عبر OAuth:

يتم توجيهه تلقائيًا إلى رابط OAuth الخاص بالمزود

بعد الموافقة على الربط يعود مباشرة إلى صفحة النسخ الاحتياطي

تظهر رسالة “تم ربط الحساب بنجاح”

هذا السلوك يجب أن ينطبق على Google Drive و Dropbox.

2 – نظام مزودات التخزين المتعددة Multi-Cloud Providers

أنشئ الخدمات التالية داخل:

k9/services/backup/


google_drive_service.py

dropbox_service.py

backup_manager.py

backup_manager.py وظيفته:

تحديد مزود/مزودات التخزين المربوطة

رفع النسخ الاحتياطية إلى أي مزود مربوط

استرجاع النسخ من المزود الصحيح

التعامل مع الأخطاء

3 – عرض مساحة التخزين Storage Usage

داخل نفس صفحة النسخ الاحتياطي الحالية:

أضِف قسمًا صغيرًا يظهر:

Google Drive Storage

Used: 12 GB

Free: 103 GB

Total: 115 GB

Status: ✓ فعال أو ✗ غير مربوط

Dropbox Storage

Used: 1.3 GB

Free: 1.7 GB

Total: 3 GB

Status: ✓ فعال أو ✗ غير مربوط

هذه البيانات يجب أن تأتي مباشرة من الـ APIs الرسمية:

Google Drive → about.get() API

Dropbox → /users/get_space_usage API

إذا لم يكن الحساب مربوطًا:

بدلاً من الأرقام، اكتب: "غير مربوط — اضغط للربط"

4 – زر النسخ الاحتياطي الحالي

الزر الحالي “إنشاء نسخة احتياطية الآن” يجب أن:

يرفع النسخة إلى Google Drive (إن كان مربوطًا)

يرفع النسخة إلى Dropbox (إن كان مربوطًا)

أو إلى الاثنين معًا

بدون أي تغييرات في الواجهة

5 – الاسترجاع Restore

نفس زر الاسترجاع الحالي:

يجب أن يسترجع النسخة من المزود الصحيح (Google أو Dropbox)، بناءً على provider المخزن في metadata الخاصة بالنسخة.

6 – تحديث قاعدة البيانات

تأكد من وجود جدول:

user_cloud_integrations
(id, user_id, provider, access_token, refresh_token, expires_at)


وإذا لم يكن موجودًا، قم بإنشائه.

7 – اختبار النظام بعد التنفيذ
اختبار 1 — Google Drive فقط

اضغط Backup

يُحوَّل المستخدم تلقائيًا لـ OAuth

بعد الربط → يجب أن يظهر تخزين Google Drive + رفع النسخة بنجاح

اختبار 2 — Dropbox فقط

اضغط Backup

يُحوَّل المستخدم لـ OAuth

بعد الربط → يجب أن يظهر تخزين Dropbox + رفع النسخة بنجاح

اختبار 3 — كلاهما معًا

اربط Google Drive + Dropbox

اضغط Backup → يجب أن يرفع النسخة للمزودين

يظهر التخزين لكليهما

اختبار 4 — استرجاع

استرجاع نسخة من Google Drive

استرجاع نسخة من Dropbox

في كلا الحالتين يجب أن يعمل بدون خطأ

المطلوب الآن تنفيذ هذا النظام بالكامل باستخدام الواجهة الحالية فقط، ودعم الربط التلقائي، ودعم Google Drive + Dropbox مع عرض المساحة المستخدمة والمتبقية لكل خدمة.