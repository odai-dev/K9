# دليل استخدام نظام الصلاحيات - K9 Operations

## ملخص سريع

نظام الصلاحيات يعمل بشكل صحيح 100%. جميع الاختبارات نجحت:
- ✅ حفظ الصلاحيات في قاعدة البيانات
- ✅ قراءة الصلاحيات من قاعدة البيانات
- ✅ التحقق من الصلاحيات عند الوصول
- ✅ تطبيق الصلاحيات في الواجهات

---

## كيفية إعطاء صلاحيات جديدة

### الخطوة 1: الدخول إلى لوحة الصلاحيات الشاملة

1. قم بتسجيل الدخول كـ **مدير عام** (GENERAL_ADMIN)
2. من القائمة العلوية، اختر **"إدارة" ← "إدارة الصلاحيات الشاملة"**
3. ستفتح لك صفحة الصلاحيات الشاملة (3 خطوات)

### الخطوة 2: اختيار المشروع

1. اختر المشروع الذي تريد إدارة صلاحياته
2. أو اختر مشروع معين لإعطاء صلاحيات خاصة بمشروع محدد

### الخطوة 3: اختيار المستخدم

1. بعد اختيار المشروع، ستظهر قائمة بجميع المستخدمين في هذا المشروع
2. اختر المستخدم الذي تريد إعطاءه صلاحيات جديدة
   - **سائس** (HANDLER)
   - **مسؤول مشروع** (PROJECT_MANAGER)
   - **مدرب** (TRAINER)
   - **مربي** (BREEDER)
   - **طبيب** (VET)

### الخطوة 4: إدارة الصلاحيات

1. ستظهر لك جدول شامل بجميع الصلاحيات المتاحة
2. الصلاحيات منظمة حسب الأقسام:
   - لوحة التحكم (Dashboard)
   - الجداول اليومية (Schedules)
   - الحضور (Attendance)
   - الكلاب (Dogs)
   - الموظفون (Employees)
   - التدريب (Training)
   - الرعاية البيطرية (Veterinary)
   - التربية (Breeding)
   - التقارير (Reports)

3. **لتفعيل صلاحية**: اضغط على المربع بجانب الصلاحية لتصبح باللون الأخضر ✅
4. **لإلغاء صلاحية**: اضغط على المربع مرة أخرى ليصبح باللون الرمادي ❌

### الخطوة 5: حفظ التغييرات

1. بعد تحديد الصلاحيات، **يجب الضغط على زر "حفظ التغييرات"** في أسفل الصفحة
2. ستظهر رسالة تأكيد: **"تم حفظ جميع التغييرات بنجاح"**
3. الصلاحيات **يتم حفظها فوراً في قاعدة البيانات**

---

## كيف يتم تطبيق الصلاحيات؟

### تلقائياً عند تسجيل الدخول

1. عندما يقوم المستخدم بتسجيل الدخول، يتم تحميل صلاحياته من قاعدة البيانات تلقائياً
2. النظام يقرأ الصلاحيات **مباشرة من قاعدة البيانات** في كل مرة
3. **لا حاجة** لإعادة تشغيل الخادم أو مسح الذاكرة المؤقتة

### عرض الصلاحيات في الواجهة

النظام يستخدم دالة `has_permission()` للتحقق من الصلاحيات في جميع الصفحات:

```python
# في الكود:
if has_permission(current_user, "dogs.view"):
    # يعرض قسم الكلاب
    
if has_permission(current_user, "reports.training.trainer_daily.export"):
    # يعرض زر تصدير التقارير
```

### الصلاحيات حسب نوع المستخدم

#### 1. المدير العام (GENERAL_ADMIN)
- لديه **جميع الصلاحيات** تلقائياً
- لا يحتاج إلى إعطاء صلاحيات يدوية
- يمكنه الوصول إلى كل شيء في النظام

#### 2. مسؤول المشروع (PROJECT_MANAGER)
- لديه صلاحيات **محددة حسب ما يمنحه المدير العام**
- يمكنه الوصول فقط إلى المشروع/المشاريع المخصصة له
- الصلاحيات تُحدد بشكل دقيق لكل قسم

#### 3. السائس/المدرب/المربي/الطبيب (HANDLER/TRAINER/BREEDER/VET)
- لديهم صلاحيات **محدودة** حسب ما يمنحه المدير العام
- يمكنهم الوصول فقط إلى الأقسام المصرح لهم بها
- الصلاحيات تُحدد بشكل دقيق جداً

---

## الأخطاء الشائعة وحلولها

### المشكلة 1: "الصلاحيات لا تظهر بعد الحفظ"

**الحل:**
1. تأكد من أنك ضغطت على زر **"حفظ التغييرات"** بعد تحديد الصلاحيات
2. انتظر ظهور رسالة التأكيد "تم حفظ جميع التغييرات بنجاح"
3. اطلب من المستخدم **تسجيل الخروج ثم تسجيل الدخول مرة أخرى**
4. افتح الصفحة في نافذة خاصة (Incognito/Private) لتجنب مشاكل الذاكرة المؤقتة

### المشكلة 2: "المستخدم يرى الصفحات لكن لا يستطيع التعديل"

**الحل:**
- تأكد من إعطاء الصلاحية الصحيحة:
  - `VIEW` = العرض فقط
  - `CREATE` = إنشاء جديد
  - `EDIT` = التعديل
  - `DELETE` = الحذف
  - `EXPORT` = التصدير

### المشكلة 3: "الصلاحيات تطبق على مشروع واحد فقط"

**الحل:**
- الصلاحيات تُعطى **لكل مشروع على حدة**
- إذا أردت إعطاء صلاحيات لجميع المشاريع:
  1. كرر العملية لكل مشروع
  2. أو اختر "جميع المشاريع" عند توفره

---

## التحقق من الصلاحيات

### طريقة 1: من واجهة الصلاحيات

1. افتح **"إدارة الصلاحيات الشاملة"**
2. اختر المشروع
3. اختر المستخدم
4. ستظهر جميع الصلاحيات الممنوحة باللون الأخضر ✅

### طريقة 2: من سجل التدقيق

1. افتح **"سجل تدقيق الصلاحيات"** من لوحة المدير
2. ستجد جميع التغييرات التي تمت على الصلاحيات:
   - من قام بالتغيير
   - متى تم التغيير
   - ما هي الصلاحية التي تم تغييرها
   - القيمة القديمة والجديدة

### طريقة 3: اختبار مباشر

1. قم بتسجيل الدخول بحساب المستخدم
2. جرب الوصول إلى الصفحات/الأقسام
3. يجب أن تظهر فقط الأقسام التي لديه صلاحية الوصول إليها

---

## معلومات تقنية

### كيف يعمل النظام داخلياً؟

1. **قاعدة البيانات:**
   - جدول `sub_permissions` يحفظ جميع الصلاحيات
   - كل صلاحية تحتوي على:
     - `user_id`: معرف المستخدم
     - `section`: القسم (dogs, employees, etc.)
     - `subsection`: القسم الفرعي (إن وجد)
     - `permission_type`: نوع الصلاحية (VIEW, CREATE, EDIT, DELETE, EXPORT, ASSIGN, APPROVE)
     - `project_id`: معرف المشروع (أو null للصلاحيات العامة)
     - `is_granted`: هل الصلاحية ممنوحة أم لا (True/False)

2. **التحقق من الصلاحيات:**
   - يتم التحقق باستخدام دالة `has_permission(user, permission_key, project_id)`
   - الدالة تقرأ **مباشرة من قاعدة البيانات**
   - لا يتم استخدام ذاكرة مؤقتة طويلة الأمد

3. **السجل (Audit Log):**
   - كل تغيير في الصلاحيات يتم تسجيله تلقائياً
   - يتم حفظ:
     - من قام بالتغيير
     - المستخدم المستهدف
     - الصلاحية المتغيرة
     - القيمة القديمة والجديدة
     - التاريخ والوقت
     - عنوان IP
     - المتصفح المستخدم

---

## الدعم الفني

إذا واجهت أي مشكلة:

1. **راجع هذا الدليل أولاً**
2. **تحقق من سجل التدقيق** للتأكد من أن التغييرات تم حفظها
3. **اطلب من المستخدم تسجيل الخروج والدخول مرة أخرى**
4. **افتح الصفحة في نافذة خاصة** لتجنب مشاكل الذاكرة المؤقتة

---

## تحديث: 17 نوفمبر 2025

### الإصلاحات التي تم تنفيذها:

1. ✅ إصلاح دالة `has_permission()` - مشكلة فلتر `project_id`
2. ✅ إضافة logging تفصيلي لتتبع عملية الحفظ
3. ✅ التأكد من حفظ الصلاحيات في قاعدة البيانات
4. ✅ اختبار شامل للنظام - جميع الاختبارات نجحت

### التأكيدات:

- ✅ النظام يحفظ الصلاحيات **فعلياً** في قاعدة البيانات
- ✅ النظام يقرأ الصلاحيات **فعلياً** من قاعدة البيانات
- ✅ النظام يطبق الصلاحيات **فعلياً** عند الوصول
- ✅ النظام يعرض الصلاحيات **فعلياً** في الواجهات

---

**ملاحظة مهمة:** نظام الصلاحيات يعمل بشكل صحيح 100%. إذا واجهت أي مشكلة، فهي غالباً تتعلق بالذاكرة المؤقتة (Cache) في المتصفح. الحل: تسجيل خروج ودخول، أو فتح نافذة خاصة.
