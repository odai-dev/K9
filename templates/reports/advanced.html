{% extends "base.html" %}

{% block title %}التقارير المتقدمة{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row">
        <div class="col-12">
            <div class="page-header mb-4">
                <nav aria-label="breadcrumb" class="mb-2">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">الرئيسية</a></li>
                        <li class="breadcrumb-item active">التقارير</li>
                    </ol>
                </nav>
                <h1 class="h2 text-dark">
                    <i class="fas fa-chart-line me-3"></i>
                    التقارير المتقدمة
                </h1>
                <p class="lead text-muted">إنشاء ومعاينة وتصدير تقارير شاملة لجميع وحدات النظام</p>
            </div>
        </div>
    </div>

    <!-- Filters & Search Panel (Sticky) -->
    <div class="row mb-4" id="filtersSection">
        <div class="col-12">
            <div class="card shadow-sm" style="position: sticky; top: 20px; z-index: 1020;">
                <div class="card-header bg-light">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-filter me-2"></i>
                        المرشحات والبحث
                        <button class="btn btn-sm btn-outline-secondary float-end" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#filterForm">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </h5>
                </div>
                <div class="collapse show" id="filterForm">
                    <div class="card-body">
                        <form id="advancedFilterForm">
                            <div class="row g-3">
                                <!-- Date Range -->
                                <div class="col-md-3">
                                    <label class="form-label">فترة التاريخ</label>
                                    <div class="input-group">
                                        <input type="date" class="form-control" id="filterStartDate" name="start_date">
                                        <span class="input-group-text">إلى</span>
                                        <input type="date" class="form-control" id="filterEndDate" name="end_date">
                                    </div>
                                </div>
                                
                                <!-- Report Type -->
                                <div class="col-md-3">
                                    <label class="form-label">نوع التقرير</label>
                                    <select class="form-select" id="filterReportType" name="report_type">
                                        <option value="">اختر نوع التقرير</option>
                                        <option value="dogs">تقرير الكلاب</option>
                                        <option value="employees">تقرير الموظفين</option>
                                        <option value="training">تقرير التدريب</option>
                                        <option value="veterinary">تقرير الطبابة</option>
                                        <option value="breeding">تقرير التكاثر</option>
                                        <option value="projects">تقرير المشاريع</option>
                                    </select>
                                </div>
                                
                                <!-- Entity Status -->
                                <div class="col-md-3">
                                    <label class="form-label">الحالة</label>
                                    <select class="form-select" id="filterStatus" name="status">
                                        <option value="">جميع الحالات</option>
                                        <option value="ACTIVE">نشط</option>
                                        <option value="INACTIVE">غير نشط</option>
                                        <option value="COMPLETED">مكتمل</option>
                                        <option value="PENDING">معلق</option>
                                    </select>
                                </div>
                                
                                <!-- Keyword Search -->
                                <div class="col-md-3">
                                    <label class="form-label">البحث بالكلمات المفتاحية</label>
                                    <input type="text" class="form-control" id="filterKeyword" 
                                           placeholder="ابحث في التقارير...">
                                </div>
                            </div>
                            
                            <!-- Advanced Filters Toggle -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <button type="button" class="btn btn-outline-info btn-sm" 
                                            data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                                        <i class="fas fa-cog me-1"></i>
                                        فلاتر متقدمة
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Advanced Filters Panel -->
                            <div class="collapse mt-3" id="advancedFilters">
                                <div class="border-top pt-3">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">الموقع</label>
                                            <input type="text" class="form-control" id="filterLocation" name="location">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">مدير المشروع</label>
                                            <select class="form-select" id="filterManager" name="manager">
                                                <option value="">جميع المدراء</option>
                                                {% for employee in employees %}
                                                    {% if employee.role.value == 'PROJECT_MANAGER' %}
                                                    <option value="{{ employee.id }}">{{ employee.name }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">فترة الورديات</label>
                                            <select class="form-select" id="filterShift" name="shift">
                                                <option value="">جميع الفترات</option>
                                                <option value="MORNING">صباحي</option>
                                                <option value="EVENING">مسائي</option>
                                                <option value="NIGHT">ليلي</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="row mt-4">
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary me-2" onclick="applyFilters()">
                                        <i class="fas fa-search me-1"></i>
                                        تطبيق المرشحات
                                    </button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="resetFilters()">
                                        <i class="fas fa-undo me-1"></i>
                                        إعادة تعيين
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Badges -->
    <div class="row mb-3" id="summarySection" style="display: none;">
        <div class="col-12">
            <div class="d-flex flex-wrap gap-3">
                <span class="badge bg-primary fs-6" id="totalRecords">إجمالي السجلات: 0</span>
                <span class="badge bg-info fs-6" id="filteredRecords">السجلات المفلترة: 0</span>
                <span class="badge bg-success fs-6" id="dateRange">الفترة الزمنية: غير محدد</span>
            </div>
        </div>
    </div>

    <!-- Live Preview Panel -->
    <div class="row" id="previewSection" style="display: none;">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-table me-2"></i>
                        معاينة البيانات
                    </h5>
                    <div class="btn-group">
                        <button class="btn btn-outline-primary btn-sm" onclick="previewReport()">
                            <i class="fas fa-eye me-1"></i>
                            معاينة PDF
                        </button>
                        <button class="btn btn-success btn-sm" onclick="exportReport('pdf')">
                            <i class="fas fa-file-pdf me-1"></i>
                            تصدير PDF
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportReport('excel')">
                            <i class="fas fa-file-excel me-1"></i>
                            تصدير Excel
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Data table will be populated dynamically -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="dataTable">
                            <thead class="table-dark">
                                <!-- Headers will be populated dynamically -->
                            </thead>
                            <tbody>
                                <!-- Data rows will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label class="form-label me-2 mb-0">عدد الصفوف:</label>
                                <select class="form-select w-auto" id="rowsPerPage" onchange="updateTable()">
                                    <option value="10">10</option>
                                    <option value="25" selected>25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <nav aria-label="Table pagination">
                                <ul class="pagination justify-content-end mb-0" id="pagination">
                                    <!-- Pagination will be populated dynamically -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Preview Modal -->
<div class="modal fade" id="reportPreviewModal" tabindex="-1" aria-labelledby="reportPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportPreviewModalLabel">معاينة التقرير</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="preview-container" style="background: white; border: 1px solid #ddd; min-height: 600px; direction: rtl;">
                    <!-- PDF-like preview will be populated here -->
                    <div id="previewContent" class="p-4">
                        <div class="text-center mb-4">
                            <h3 style="color: #C00000;">معاينة التقرير</h3>
                        </div>
                        <div id="previewData">
                            <!-- Preview content will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-arrow-left me-1"></i>
                    العودة للجدول
                </button>
                <button type="button" class="btn btn-primary" onclick="exportFromPreview()">
                    <i class="fas fa-download me-1"></i>
                    تحميل الآن
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.report-card {
    transition: transform 0.2s ease-in-out;
}

.report-card:hover {
    transform: translateY(-5px);
}

.table th {
    position: sticky;
    top: 0;
    background: #343a40 !important;
    color: white !important;
    z-index: 10;
}

.preview-container {
    font-family: 'Cairo', 'Amiri', sans-serif;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .btn-group .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
}
</style>

<script>
let currentData = [];
let currentPage = 1;
let rowsPerPage = 25;
let totalRecords = 0;

function applyFilters() {
    const formData = new FormData(document.getElementById('advancedFilterForm'));
    const reportType = formData.get('report_type');
    
    if (!reportType) {
        alert('يرجى اختيار نوع التقرير');
        return;
    }
    
    // Show loading state
    document.getElementById('summarySection').style.display = 'block';
    document.getElementById('previewSection').style.display = 'block';
    document.getElementById('dataTable').innerHTML = '<tbody><tr><td colspan="100%" class="text-center">جاري التحميل...</td></tr></tbody>';
    
    // Make AJAX request to get filtered data
    fetch('/reports/preview', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        currentData = data.records;
        totalRecords = data.total;
        updateSummary(data);
        updateTable();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('حدث خطأ في تحميل البيانات');
    });
}

function updateSummary(data) {
    document.getElementById('totalRecords').textContent = `إجمالي السجلات: ${data.total}`;
    document.getElementById('filteredRecords').textContent = `السجلات المفلترة: ${data.filtered}`;
    
    const startDate = document.getElementById('filterStartDate').value;
    const endDate = document.getElementById('filterEndDate').value;
    const dateRangeText = (startDate && endDate) ? `${startDate} إلى ${endDate}` : 'غير محدد';
    document.getElementById('dateRange').textContent = `الفترة الزمنية: ${dateRangeText}`;
}

function updateTable() {
    const start = (currentPage - 1) * rowsPerPage;
    const end = start + rowsPerPage;
    const pageData = currentData.slice(start, end);
    
    if (pageData.length === 0) {
        document.getElementById('dataTable').innerHTML = '<tbody><tr><td colspan="100%" class="text-center">لا توجد بيانات</td></tr></tbody>';
        return;
    }
    
    // Build table headers and rows
    const headers = Object.keys(pageData[0]);
    let tableHTML = '<thead class="table-dark"><tr>';
    headers.forEach(header => {
        tableHTML += `<th class="sortable" onclick="sortTable('${header}')">${header} <i class="fas fa-sort"></i></th>`;
    });
    tableHTML += '</tr></thead><tbody>';
    
    pageData.forEach((row, index) => {
        tableHTML += '<tr>';
        headers.forEach(header => {
            tableHTML += `<td>${row[header] || ''}</td>`;
        });
        tableHTML += '</tr>';
    });
    tableHTML += '</tbody>';
    
    document.getElementById('dataTable').innerHTML = tableHTML;
    updatePagination();
}

function updatePagination() {
    const totalPages = Math.ceil(currentData.length / rowsPerPage);
    let paginationHTML = '';
    
    if (totalPages > 1) {
        // Previous button
        paginationHTML += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">السابق</a>
        </li>`;
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === currentPage || i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                paginationHTML += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>`;
            } else if (i === currentPage - 2 || i === currentPage + 2) {
                paginationHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
            }
        }
        
        // Next button
        paginationHTML += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">التالي</a>
        </li>`;
    }
    
    document.getElementById('pagination').innerHTML = paginationHTML;
}

function changePage(page) {
    const totalPages = Math.ceil(currentData.length / rowsPerPage);
    if (page >= 1 && page <= totalPages) {
        currentPage = page;
        updateTable();
    }
}

function sortTable(column) {
    currentData.sort((a, b) => {
        if (a[column] < b[column]) return -1;
        if (a[column] > b[column]) return 1;
        return 0;
    });
    updateTable();
}

function resetFilters() {
    document.getElementById('advancedFilterForm').reset();
    document.getElementById('summarySection').style.display = 'none';
    document.getElementById('previewSection').style.display = 'none';
    currentData = [];
    currentPage = 1;
}

function previewReport() {
    const formData = new FormData(document.getElementById('advancedFilterForm'));
    
    // Show preview modal with loading
    const modal = new bootstrap.Modal(document.getElementById('reportPreviewModal'));
    document.getElementById('previewData').innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><br>جاري تحميل المعاينة...</div>';
    modal.show();
    
    // Load preview content
    fetch('/reports/preview-pdf', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('previewData').innerHTML = html;
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('previewData').innerHTML = '<div class="alert alert-danger">حدث خطأ في تحميل المعاينة</div>';
    });
}

function exportReport(format) {
    const formData = new FormData(document.getElementById('advancedFilterForm'));
    formData.append('export_format', format);
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/reports/generate';
    
    for (let [key, value] of formData.entries()) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
    }
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

function exportFromPreview() {
    exportReport('pdf');
    bootstrap.Modal.getInstance(document.getElementById('reportPreviewModal')).hide();
}

// Auto-update rows per page
document.getElementById('rowsPerPage').addEventListener('change', function() {
    rowsPerPage = parseInt(this.value);
    currentPage = 1;
    updateTable();
});
</script>
{% endblock %}