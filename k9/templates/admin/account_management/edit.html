{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
.permission-category {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 1rem;
}
.permission-category-header {
    background: #f8f9fa;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e9ecef;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
}
.permission-category-header:hover {
    background: #e9ecef;
}
.permission-category-body {
    padding: 1rem;
}
.permission-item {
    padding: 0.75rem;
    border-bottom: 1px dashed #e9ecef;
    border-radius: 4px;
    transition: background-color 0.2s;
}
.permission-item:last-child {
    border-bottom: none;
}
.permission-item:hover {
    background-color: #f8f9fa;
}
.permission-key {
    font-family: monospace;
    font-size: 0.8rem;
    color: #6c757d;
    direction: ltr;
    text-align: left;
}
.override-select {
    min-width: 140px;
    font-size: 0.85rem;
}
.baseline-badge {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}
.status-indicator {
    font-size: 0.75rem;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
}
.status-baseline {
    background-color: #e9ecef;
    color: #495057;
}
.status-granted {
    background-color: #d4edda;
    color: #155724;
}
.status-revoked {
    background-color: #f8d7da;
    color: #721c24;
}
.permission-name {
    font-weight: 500;
}
.legend-box {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}
.legend-item {
    display: inline-flex;
    align-items: center;
    margin-left: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-user-edit me-2"></i>
                {{ page_title }}
            </h1>
            <a href="{{ url_for('account_management.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right me-1"></i>
                العودة للقائمة
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user me-2"></i>
                    معلومات الحساب
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <th class="text-muted" style="width: 40%;">اسم المستخدم</th>
                        <td><strong>{{ user.username }}</strong></td>
                    </tr>
                    <tr>
                        <th class="text-muted">الاسم الكامل</th>
                        <td>{{ user.full_name or '-' }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">البريد</th>
                        <td>{{ user.email }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">الهاتف</th>
                        <td>{{ user.phone or '-' }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">الدور</th>
                        <td>
                            {% if user.role.name == 'GENERAL_ADMIN' %}
                            <span class="badge bg-danger">مدير عام</span>
                            {% elif user.role.name == 'PROJECT_MANAGER' %}
                            <span class="badge bg-primary">مسؤول مشروع</span>
                            {% elif user.role.name == 'HANDLER' %}
                            <span class="badge bg-info">سائس</span>
                            {% elif user.role.name == 'TRAINER' %}
                            <span class="badge bg-success">مدرب</span>
                            {% elif user.role.name == 'BREEDER' %}
                            <span class="badge bg-warning">مربي</span>
                            {% elif user.role.name == 'VET' %}
                            <span class="badge bg-secondary">طبيب</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-muted">الحالة</th>
                        <td>
                            {% if user.active %}
                            <span class="badge bg-success">نشط</span>
                            {% else %}
                            <span class="badge bg-secondary">معطل</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if employee %}
                    <tr>
                        <th class="text-muted">الموظف المرتبط</th>
                        <td>
                            <i class="fas fa-check-circle text-success me-1"></i>
                            {{ employee.name }}
                            <small class="text-muted d-block">({{ employee.employee_id }})</small>
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2 text-warning"></i>
                        إدارة صلاحيات المستخدم
                    </h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="resetAll">
                            <i class="fas fa-undo me-1"></i>
                            إعادة تعيين الكل
                        </button>
                    </div>
                </div>
                <div class="legend-box mt-3">
                    <strong class="d-block mb-2">
                        <i class="fas fa-info-circle me-1 text-primary"></i>
                        دليل الحالات:
                    </strong>
                    <div class="d-flex flex-wrap gap-3">
                        <div class="legend-item">
                            <span class="status-indicator status-baseline me-2">
                                <i class="fas fa-shield-alt"></i>
                            </span>
                            <small>مضمّن في الدور (أساسي)</small>
                        </div>
                        <div class="legend-item">
                            <span class="status-indicator status-granted me-2">
                                <i class="fas fa-plus-circle"></i>
                            </span>
                            <small>ممنوح إضافياً</small>
                        </div>
                        <div class="legend-item">
                            <span class="status-indicator status-revoked me-2">
                                <i class="fas fa-minus-circle"></i>
                            </span>
                            <small>محجوب</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form id="permissionsForm">
                    {% for module_key, category in permission_categories.items() %}
                    <div class="permission-category">
                        <div class="permission-category-header d-flex justify-content-between align-items-center" 
                             data-bs-toggle="collapse" 
                             data-bs-target="#category-{{ module_key }}">
                            <div>
                                <i class="fas {{ category.icon }} me-2 text-primary"></i>
                                <strong>{{ category.name_ar }}</strong>
                                <span class="badge bg-secondary ms-2">{{ category.permissions|length }}</span>
                            </div>
                            <i class="fas fa-chevron-down text-muted"></i>
                        </div>
                        <div class="collapse" id="category-{{ module_key }}">
                            <div class="permission-category-body">
                                {% for perm in category.permissions %}
                                {% set is_in_baseline = perm.key in role_baseline_permissions %}
                                {% set current_state = current_overrides.get(perm.key, None) %}
                                <div class="permission-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-5">
                                            <div class="d-flex align-items-center">
                                                <span class="permission-name">{{ perm.action_ar }}</span>
                                                {% if is_in_baseline %}
                                                <span class="baseline-badge bg-info text-white ms-2" title="مضمّن في الدور الأساسي">
                                                    <i class="fas fa-shield-alt"></i>
                                                    الدور
                                                </span>
                                                {% endif %}
                                            </div>
                                            <span class="permission-key">{{ perm.key }}</span>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select form-select-sm override-select permission-override"
                                                    data-perm-key="{{ perm.key }}"
                                                    data-in-baseline="{{ 'true' if is_in_baseline else 'false' }}">
                                                <option value="default" {% if current_state is none %}selected{% endif %}>
                                                    افتراضي (استخدام الدور)
                                                </option>
                                                <option value="grant" {% if current_state == true %}selected{% endif %}>
                                                    منح إضافي
                                                </option>
                                                <option value="revoke" {% if current_state == false %}selected{% endif %}>
                                                    حجب
                                                </option>
                                            </select>
                                        </div>
                                        <div class="col-md-3 text-end">
                                            <span class="status-indicator 
                                                {% if current_state == true %}status-granted
                                                {% elif current_state == false %}status-revoked
                                                {% elif is_in_baseline %}status-baseline
                                                {% else %}text-muted{% endif %}"
                                                id="status-{{ perm.key|replace('.', '-') }}">
                                                {% if current_state == true %}
                                                <i class="fas fa-plus-circle"></i> ممنوح
                                                {% elif current_state == false %}
                                                <i class="fas fa-minus-circle"></i> محجوب
                                                {% elif is_in_baseline %}
                                                <i class="fas fa-shield-alt"></i> أساسي
                                                {% else %}
                                                <i class="fas fa-ban"></i> غير متاح
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="saveBtn">
                            <i class="fas fa-save me-2"></i>
                            حفظ الصلاحيات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>
                    نتيجة العملية
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div id="resultIcon"></div>
                <p id="resultMessage" class="mb-0 mt-3"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('permissionsForm');
    const saveBtn = document.getElementById('saveBtn');
    const resetAllBtn = document.getElementById('resetAll');
    const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
    
    function updateStatusIndicator(selectElement) {
        const permKey = selectElement.dataset.permKey;
        const inBaseline = selectElement.dataset.inBaseline === 'true';
        const statusId = 'status-' + permKey.replace(/\./g, '-');
        const statusEl = document.getElementById(statusId);
        
        if (!statusEl) return;
        
        const value = selectElement.value;
        
        statusEl.classList.remove('status-granted', 'status-revoked', 'status-baseline', 'text-muted');
        
        if (value === 'grant') {
            statusEl.classList.add('status-granted');
            statusEl.innerHTML = '<i class="fas fa-plus-circle"></i> ممنوح';
        } else if (value === 'revoke') {
            statusEl.classList.add('status-revoked');
            statusEl.innerHTML = '<i class="fas fa-minus-circle"></i> محجوب';
        } else {
            if (inBaseline) {
                statusEl.classList.add('status-baseline');
                statusEl.innerHTML = '<i class="fas fa-shield-alt"></i> أساسي';
            } else {
                statusEl.classList.add('text-muted');
                statusEl.innerHTML = '<i class="fas fa-ban"></i> غير متاح';
            }
        }
    }
    
    document.querySelectorAll('.permission-override').forEach(select => {
        select.addEventListener('change', function() {
            updateStatusIndicator(this);
        });
    });
    
    resetAllBtn.addEventListener('click', function() {
        if (confirm('هل أنت متأكد من إعادة تعيين جميع الصلاحيات للقيم الافتراضية؟')) {
            document.querySelectorAll('.permission-override').forEach(select => {
                select.value = 'default';
                updateStatusIndicator(select);
            });
        }
    });
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...';
        
        const grants = [];
        const revokes = [];
        
        document.querySelectorAll('.permission-override').forEach(select => {
            const permKey = select.dataset.permKey;
            const value = select.value;
            
            if (value === 'grant') {
                grants.push(permKey);
            } else if (value === 'revoke') {
                revokes.push(permKey);
            }
        });
        
        fetch('{{ url_for("account_management.save_permissions", user_id=user.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ grants: grants, revokes: revokes })
        })
        .then(response => response.json())
        .then(data => {
            const resultIcon = document.getElementById('resultIcon');
            const resultMessage = document.getElementById('resultMessage');
            
            if (data.success) {
                resultIcon.innerHTML = '<i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>';
                resultMessage.textContent = data.message;
                resultMessage.className = 'mb-0 mt-3 text-success';
            } else {
                resultIcon.innerHTML = '<i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>';
                resultMessage.textContent = data.message || 'حدث خطأ أثناء الحفظ';
                resultMessage.className = 'mb-0 mt-3 text-danger';
            }
            
            resultModal.show();
        })
        .catch(error => {
            const resultIcon = document.getElementById('resultIcon');
            const resultMessage = document.getElementById('resultMessage');
            resultIcon.innerHTML = '<i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>';
            resultMessage.textContent = 'حدث خطأ في الاتصال';
            resultMessage.className = 'mb-0 mt-3 text-danger';
            resultModal.show();
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>حفظ الصلاحيات';
        });
    });
    
    document.querySelectorAll('.permission-category-header').forEach(header => {
        header.addEventListener('click', function() {
            const icon = this.querySelector('.fa-chevron-down, .fa-chevron-up');
            if (icon) {
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            }
        });
    });
});
</script>
{% endblock %}
