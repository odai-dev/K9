{% extends "base.html" %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
.permission-category {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    margin-bottom: 1rem;
}
.permission-category-header {
    background: #f8f9fa;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #e9ecef;
    border-radius: 8px 8px 0 0;
    cursor: pointer;
}
.permission-category-header:hover {
    background: #e9ecef;
}
.permission-category-body {
    padding: 1rem;
}
.permission-item {
    padding: 0.5rem 0;
    border-bottom: 1px dashed #e9ecef;
}
.permission-item:last-child {
    border-bottom: none;
}
.permission-key {
    font-family: monospace;
    font-size: 0.85rem;
    color: #6c757d;
    direction: ltr;
    text-align: left;
}
.override-badge {
    font-size: 0.7rem;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-user-edit me-2"></i>
                {{ page_title }}
            </h1>
            <a href="{{ url_for('account_management.index') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-right me-1"></i>
                العودة للقائمة
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-user me-2"></i>
                    معلومات الحساب
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless mb-0">
                    <tr>
                        <th class="text-muted" style="width: 40%;">اسم المستخدم</th>
                        <td><strong>{{ user.username }}</strong></td>
                    </tr>
                    <tr>
                        <th class="text-muted">الاسم الكامل</th>
                        <td>{{ user.full_name or '-' }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">البريد</th>
                        <td>{{ user.email }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">الهاتف</th>
                        <td>{{ user.phone or '-' }}</td>
                    </tr>
                    <tr>
                        <th class="text-muted">الدور</th>
                        <td>
                            {% if user.role.name == 'GENERAL_ADMIN' %}
                            <span class="badge bg-danger">مدير عام</span>
                            {% elif user.role.name == 'PROJECT_MANAGER' %}
                            <span class="badge bg-primary">مسؤول مشروع</span>
                            {% elif user.role.name == 'HANDLER' %}
                            <span class="badge bg-info">سائس</span>
                            {% elif user.role.name == 'TRAINER' %}
                            <span class="badge bg-success">مدرب</span>
                            {% elif user.role.name == 'BREEDER' %}
                            <span class="badge bg-warning">مربي</span>
                            {% elif user.role.name == 'VET' %}
                            <span class="badge bg-secondary">طبيب</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th class="text-muted">الحالة</th>
                        <td>
                            {% if user.active %}
                            <span class="badge bg-success">نشط</span>
                            {% else %}
                            <span class="badge bg-secondary">معطل</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if employee %}
                    <tr>
                        <th class="text-muted">الموظف المرتبط</th>
                        <td>
                            <i class="fas fa-check-circle text-success me-1"></i>
                            {{ employee.name }}
                            <small class="text-muted d-block">({{ employee.employee_id }})</small>
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 pt-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2 text-warning"></i>
                        صلاحيات إضافية للمستخدم (Overrides)
                    </h5>
                    <div>
                        <button type="button" class="btn btn-sm btn-outline-secondary me-2" id="selectAll">
                            <i class="fas fa-check-double me-1"></i>
                            تحديد الكل
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAll">
                            <i class="fas fa-times me-1"></i>
                            إلغاء الكل
                        </button>
                    </div>
                </div>
                <p class="text-muted small mb-0 mt-2">
                    <i class="fas fa-info-circle me-1"></i>
                    يمكنك منح صلاحيات إضافية للمستخدم تتجاوز صلاحيات دوره الأساسي
                </p>
            </div>
            <div class="card-body">
                <form id="permissionsForm">
                    {% for module_key, category in permission_categories.items() %}
                    <div class="permission-category">
                        <div class="permission-category-header d-flex justify-content-between align-items-center" 
                             data-bs-toggle="collapse" 
                             data-bs-target="#category-{{ module_key }}">
                            <div>
                                <i class="fas {{ category.icon }} me-2 text-primary"></i>
                                <strong>{{ category.name_ar }}</strong>
                                <span class="badge bg-secondary ms-2">{{ category.permissions|length }}</span>
                            </div>
                            <i class="fas fa-chevron-down text-muted"></i>
                        </div>
                        <div class="collapse" id="category-{{ module_key }}">
                            <div class="permission-category-body">
                                {% for perm in category.permissions %}
                                <div class="permission-item d-flex justify-content-between align-items-center">
                                    <div class="form-check">
                                        <input class="form-check-input permission-checkbox" 
                                               type="checkbox" 
                                               name="permissions[]"
                                               value="{{ perm.key }}" 
                                               id="perm-{{ perm.key|replace('.', '-') }}"
                                               {% if current_overrides.get(perm.key) %}checked{% endif %}>
                                        <label class="form-check-label" for="perm-{{ perm.key|replace('.', '-') }}">
                                            {{ perm.action_ar }}
                                            {% if current_overrides.get(perm.key) %}
                                            <span class="badge bg-success override-badge ms-1">مفعّل</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                    <span class="permission-key">{{ perm.key }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="saveBtn">
                            <i class="fas fa-save me-2"></i>
                            حفظ الصلاحيات
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="resultModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>
                    نتيجة العملية
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div id="resultIcon"></div>
                <p id="resultMessage" class="mb-0 mt-3"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('permissionsForm');
    const saveBtn = document.getElementById('saveBtn');
    const selectAllBtn = document.getElementById('selectAll');
    const deselectAllBtn = document.getElementById('deselectAll');
    const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
    
    selectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = true);
    });
    
    deselectAllBtn.addEventListener('click', function() {
        document.querySelectorAll('.permission-checkbox').forEach(cb => cb.checked = false);
    });
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...';
        
        const permissions = [];
        document.querySelectorAll('.permission-checkbox:checked').forEach(cb => {
            permissions.push(cb.value);
        });
        
        fetch('{{ url_for("account_management.save_permissions", user_id=user.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            },
            body: JSON.stringify({ permissions: permissions })
        })
        .then(response => response.json())
        .then(data => {
            const resultIcon = document.getElementById('resultIcon');
            const resultMessage = document.getElementById('resultMessage');
            
            if (data.success) {
                resultIcon.innerHTML = '<i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>';
                resultMessage.textContent = data.message;
                resultMessage.className = 'mb-0 mt-3 text-success';
            } else {
                resultIcon.innerHTML = '<i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>';
                resultMessage.textContent = data.message || 'حدث خطأ أثناء الحفظ';
                resultMessage.className = 'mb-0 mt-3 text-danger';
            }
            
            resultModal.show();
        })
        .catch(error => {
            const resultIcon = document.getElementById('resultIcon');
            const resultMessage = document.getElementById('resultMessage');
            resultIcon.innerHTML = '<i class="fas fa-times-circle text-danger" style="font-size: 4rem;"></i>';
            resultMessage.textContent = 'حدث خطأ في الاتصال';
            resultMessage.className = 'mb-0 mt-3 text-danger';
            resultModal.show();
        })
        .finally(() => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>حفظ الصلاحيات';
        });
    });
    
    document.querySelectorAll('.permission-category-header').forEach(header => {
        header.addEventListener('click', function() {
            const icon = this.querySelector('.fa-chevron-down, .fa-chevron-up');
            if (icon) {
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            }
        });
    });
});
</script>
{% endblock %}
