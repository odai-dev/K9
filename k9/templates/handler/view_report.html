{% extends "base.html" %}

{% block title %}عرض التقرير - {{ report.date.strftime('%Y-%m-%d') }}{% endblock %}

{% block extra_css %}
<style>
.report-section {
    border-left: 4px solid #0d6efd;
    margin-bottom: 1.5rem;
}
.info-row {
    border-bottom: 1px solid #eee;
    padding: 0.75rem 0;
}
.info-row:last-child {
    border-bottom: none;
}
.print-hide {
    display: block;
}
@media print {
    .print-hide {
        display: none !important;
    }
    .navbar, nav {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="row print-hide">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-file-alt me-2"></i>
                عرض التقرير اليومي
            </h1>
            <div class="btn-group">
                {% if report.status.value == 'DRAFT' %}
                <a href="{{ url_for('handler.edit_report', id=report.id) }}" class="btn btn-warning">
                    <i class="fas fa-edit me-2"></i>
                    تعديل
                </a>
                {% endif %}
                <button onclick="window.print()" class="btn btn-outline-primary">
                    <i class="fas fa-print me-2"></i>
                    طباعة
                </button>
                <a href="{{ url_for('handler.my_reports') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-right me-2"></i>
                    العودة
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Report Header -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="mb-3">معلومات التقرير</h5>
                        <div class="info-row">
                            <strong>التاريخ:</strong>
                            {{ report.date.strftime('%Y-%m-%d') }} ({{ report.date.strftime('%A') }})
                        </div>
                        <div class="info-row">
                            <strong>السائس:</strong>
                            {{ current_user.full_name }}
                        </div>
                        <div class="info-row">
                            <strong>الكلب:</strong>
                            {% if report.dog %}
                                {{ report.dog.name }} ({{ report.dog.code }})
                            {% else %}
                                غير محدد
                            {% endif %}
                        </div>
                        <div class="info-row">
                            <strong>الوردية:</strong>
                            {% if report.shift %}
                                {{ report.shift.name }} ({{ report.shift.start_time.strftime('%H:%M') }} - {{ report.shift.end_time.strftime('%H:%M') }})
                            {% else %}
                                غير محدد
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="mb-3">الحالة</h5>
                        <div class="info-row">
                            <strong>حالة التقرير:</strong>
                            {% if report.status.value == 'DRAFT' %}
                                <span class="badge bg-secondary ms-2">مسودة</span>
                            {% elif report.status.value == 'SUBMITTED' %}
                                <span class="badge bg-warning ms-2">قيد المراجعة</span>
                            {% elif report.status.value == 'APPROVED' %}
                                <span class="badge bg-success ms-2">معتمد</span>
                            {% elif report.status.value == 'REJECTED' %}
                                <span class="badge bg-danger ms-2">مرفوض</span>
                            {% endif %}
                        </div>
                        {% if report.location %}
                        <div class="info-row">
                            <strong>الموقع:</strong>
                            {{ report.location }}
                        </div>
                        {% endif %}
                        {% if report.submitted_at %}
                        <div class="info-row">
                            <strong>تاريخ الإرسال:</strong>
                            {{ report.submitted_at.strftime('%Y-%m-%d %H:%M') }}
                        </div>
                        {% endif %}
                        {% if report.reviewed_at %}
                        <div class="info-row">
                            <strong>تاريخ المراجعة:</strong>
                            {{ report.reviewed_at.strftime('%Y-%m-%d %H:%M') }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                {% if report.status.value == 'REJECTED' and report.review_notes %}
                <div class="alert alert-danger mt-3 mb-0">
                    <h6 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        سبب الرفض:
                    </h6>
                    <p class="mb-0">{{ report.review_notes }}</p>
                </div>
                {% elif report.status.value == 'APPROVED' and report.review_notes %}
                <div class="alert alert-success mt-3 mb-0">
                    <h6 class="alert-heading">
                        <i class="fas fa-check-circle me-2"></i>
                        ملاحظات المراجع:
                    </h6>
                    <p class="mb-0">{{ report.review_notes }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Health Check -->
{% if report.health %}
<div class="card report-section border-0 shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0">
            <i class="fas fa-heartbeat me-2"></i>
            الفحص الصحي
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-4">
                <div class="info-row">
                    <strong>الحالة العامة:</strong>
                    <span class="ms-2">{{ report.health.overall_condition }}</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-row">
                    <strong>الشهية:</strong>
                    <span class="ms-2">{{ report.health.appetite }}</span>
                </div>
            </div>
            <div class="col-md-4">
                <div class="info-row">
                    <strong>مستوى النشاط:</strong>
                    <span class="ms-2">{{ report.health.energy_level }}</span>
                </div>
            </div>
            {% if report.health.temperature %}
            <div class="col-md-4">
                <div class="info-row">
                    <strong>درجة الحرارة:</strong>
                    <span class="ms-2">{{ report.health.temperature }} °C</span>
                </div>
            </div>
            {% endif %}
            {% if report.health.weight %}
            <div class="col-md-4">
                <div class="info-row">
                    <strong>الوزن:</strong>
                    <span class="ms-2">{{ report.health.weight }} كجم</span>
                </div>
            </div>
            {% endif %}
            {% if report.health.coat_condition %}
            <div class="col-md-4">
                <div class="info-row">
                    <strong>حالة الفراء:</strong>
                    <span class="ms-2">{{ report.health.coat_condition }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% if report.health.injuries %}
        <div class="alert alert-warning mt-3">
            <strong>الإصابات:</strong>
            {{ report.health.injuries }}
        </div>
        {% endif %}
        {% if report.health.vet_visit_needed %}
        <div class="alert alert-danger mt-3">
            <strong><i class="fas fa-exclamation-triangle me-2"></i>يحتاج زيارة بيطرية</strong>
            {% if report.health.vet_visit_reason %}
            <br>السبب: {{ report.health.vet_visit_reason }}
            {% endif %}
        </div>
        {% endif %}
        {% if report.health.notes %}
        <div class="mt-3">
            <strong>ملاحظات:</strong>
            <p class="mb-0 mt-2">{{ report.health.notes }}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Care Details -->
{% if report.care %}
<div class="card report-section border-0 shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0">
            <i class="fas fa-hand-holding-heart me-2"></i>
            الرعاية اليومية
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% if report.care.food_amount_kg %}
            <div class="col-md-4">
                <div class="info-row">
                    <strong>كمية الطعام:</strong>
                    <span class="ms-2">{{ report.care.food_amount_kg }} كجم</span>
                </div>
            </div>
            {% endif %}
            {% if report.care.water_consumption %}
            <div class="col-md-4">
                <div class="info-row">
                    <strong>استهلاك الماء:</strong>
                    <span class="ms-2">{{ report.care.water_consumption }}</span>
                </div>
            </div>
            {% endif %}
            <div class="col-md-4">
                <div class="info-row">
                    <strong>التنظيف/الاستحمام:</strong>
                    <span class="ms-2">
                        {% if report.care.grooming_done %}
                            <i class="fas fa-check text-success"></i> تم
                        {% else %}
                            <i class="fas fa-times text-danger"></i> لم يتم
                        {% endif %}
                    </span>
                </div>
            </div>
            {% if report.care.exercise_duration_minutes %}
            <div class="col-md-4">
                <div class="info-row">
                    <strong>مدة التمرين:</strong>
                    <span class="ms-2">{{ report.care.exercise_duration_minutes }} دقيقة</span>
                </div>
            </div>
            {% endif %}
            {% if report.care.exercise_type %}
            <div class="col-md-4">
                <div class="info-row">
                    <strong>نوع التمرين:</strong>
                    <span class="ms-2">{{ report.care.exercise_type }}</span>
                </div>
            </div>
            {% endif %}
            <div class="col-md-4">
                <div class="info-row">
                    <strong>عدد مرات الإخراج:</strong>
                    <span class="ms-2">{{ report.care.bathroom_breaks }}</span>
                </div>
            </div>
            {% if report.care.stool_condition %}
            <div class="col-md-4">
                <div class="info-row">
                    <strong>حالة البراز:</strong>
                    <span class="ms-2">{{ report.care.stool_condition }}</span>
                </div>
            </div>
            {% endif %}
        </div>
        {% if report.care.notes %}
        <div class="mt-3">
            <strong>ملاحظات:</strong>
            <p class="mb-0 mt-2">{{ report.care.notes }}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Behavior -->
{% if report.behavior %}
<div class="card report-section border-0 shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0">
            <i class="fas fa-smile me-2"></i>
            الملاحظات السلوكية
        </h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="info-row">
                    <strong>المزاج:</strong>
                    <span class="ms-2">{{ report.behavior.mood }}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>مستوى الطاعة:</strong>
                    <span class="ms-2">{{ report.behavior.obedience_level }}</span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>علامات عدوانية:</strong>
                    <span class="ms-2">
                        {% if report.behavior.aggression_signs %}
                            <i class="fas fa-exclamation-triangle text-danger"></i> نعم
                        {% else %}
                            <i class="fas fa-check text-success"></i> لا
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="col-md-6">
                <div class="info-row">
                    <strong>علامات قلق:</strong>
                    <span class="ms-2">
                        {% if report.behavior.anxiety_signs %}
                            <i class="fas fa-exclamation-triangle text-warning"></i> نعم
                        {% else %}
                            <i class="fas fa-check text-success"></i> لا
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
        {% if report.behavior.social_interactions %}
        <div class="mt-3">
            <strong>التفاعلات الاجتماعية:</strong>
            <p class="mb-0 mt-2">{{ report.behavior.social_interactions }}</p>
        </div>
        {% endif %}
        {% if report.behavior.unusual_behaviors %}
        <div class="alert alert-warning mt-3">
            <strong>سلوكيات غير عادية:</strong>
            <p class="mb-0">{{ report.behavior.unusual_behaviors }}</p>
        </div>
        {% endif %}
        {% if report.behavior.notes %}
        <div class="mt-3">
            <strong>ملاحظات:</strong>
            <p class="mb-0 mt-2">{{ report.behavior.notes }}</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Training Logs -->
{% if report.training_logs %}
<div class="card report-section border-0 shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0">
            <i class="fas fa-graduation-cap me-2"></i>
            سجلات التدريب
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>نوع التدريب</th>
                        <th>المدة</th>
                        <th>التقييم</th>
                        <th>الملاحظات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for log in report.training_logs %}
                    <tr>
                        <td>{{ log.training_type }}</td>
                        <td>{{ log.duration_minutes }} دقيقة</td>
                        <td>
                            <span class="badge bg-{{ 'success' if log.performance_rating >= 4 else 'warning' if log.performance_rating >= 3 else 'danger' }}">
                                {{ log.performance_rating }}/5
                            </span>
                        </td>
                        <td>{{ log.notes or '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Incidents -->
{% if report.incidents %}
<div class="card report-section border-0 shadow-sm border-danger">
    <div class="card-header bg-danger text-white">
        <h5 class="mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>
            الحوادث والطوارئ
        </h5>
    </div>
    <div class="card-body">
        {% for incident in report.incidents %}
        <div class="alert alert-{{ 'danger' if incident.severity == 'خطير' else 'warning' }} mb-3">
            <h6 class="alert-heading">
                {{ incident.incident_type }} - {{ incident.severity }}
            </h6>
            <p class="mb-2"><strong>الوقت:</strong> {{ incident.incident_time.strftime('%H:%M') }}</p>
            <p class="mb-2"><strong>الوصف:</strong> {{ incident.description }}</p>
            {% if incident.action_taken %}
            <p class="mb-2"><strong>الإجراء المتخذ:</strong> {{ incident.action_taken }}</p>
            {% endif %}
            {% if incident.reported_to_supervisor %}
            <p class="mb-0"><i class="fas fa-check text-success"></i> تم إبلاغ المشرف</p>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endblock %}
