# دليل نظام إدارة الصلاحيات الشامل

## نظرة عامة
نظام إدارة الصلاحيات يتيح للمدير العام التحكم الكامل في صلاحيات المستخدمين حسب المشروع.

## الميزات الرئيسية

### 1. إدارة الصلاحيات الشاملة (`/admin/permissions/comprehensive`)
واجهة متقدمة لإدارة الصلاحيات بثلاث خطوات:

#### الخطوة 1: اختيار المشروع
- عرض جميع المشاريع في النظام
- بحث سريع عن المشاريع
- عرض معلومات المشروع (الاسم، الكود، عدد الموظفين)

#### الخطوة 2: اختيار المستخدم
- عرض جميع المستخدمين المرتبطين بالمشروع المحدد
- بحث سريع عن المستخدمين
- عرض معلومات المستخدم (الاسم، الدور، رقم الموظف)

#### الخطوة 3: إدارة الصلاحيات
- عرض جميع الصلاحيات المتاحة مجمعة حسب القسم
- تفعيل/إلغاء تفعيل الصلاحيات بشكل فردي
- تفعيل/إلغاء جميع الصلاحيات دفعة واحدة
- مؤشر التغييرات: يعرض عدد الصلاحيات التي تم تغييرها
- حفظ التغييرات: يحفظ جميع التغييرات في قاعدة البيانات

### 2. أنواع الصلاحيات المتاحة

#### صلاحيات العرض (VIEW)
- عرض البيانات والتقارير

#### صلاحيات الإنشاء (CREATE)
- إنشاء سجلات جديدة

#### صلاحيات التعديل (EDIT)
- تعديل السجلات الموجودة

#### صلاحيات الحذف (DELETE)
- حذف السجلات

#### صلاحيات التصدير (EXPORT)
- تصدير البيانات والتقارير

#### صلاحيات التعيين (ASSIGN)
- تعيين الموارد والمهام

#### صلاحيات الموافقة (APPROVE)
- الموافقة على التقارير والطلبات

### 3. الأقسام الرئيسية للصلاحيات

#### إدارة الكلاب (DOGS)
- عرض الكلاب
- إضافة كلاب جديدة
- تعديل بيانات الكلاب
- حذف الكلاب
- تصدير بيانات الكلاب

#### إدارة الموظفين (EMPLOYEES)
- عرض الموظفين
- إضافة موظفين جدد
- تعديل بيانات الموظفين
- حذف الموظفين
- تصدير بيانات الموظفين

#### إدارة التدريب (TRAINING)
- عرض جلسات التدريب
- إنشاء جلسات جديدة
- تعديل الجلسات
- حذف الجلسات
- تصدير تقارير التدريب

#### إدارة الرعاية الصحية (VETERINARY)
- عرض السجلات الطبية
- إضافة فحوصات طبية
- تعديل السجلات
- حذف السجلات
- تصدير التقارير الطبية

#### إدارة التربية (BREEDING)
- عرض سجلات التربية
- إضافة سجلات جديدة
- تعديل السجلات
- حذف السجلات
- تصدير التقارير

#### التقارير اليومية (REPORTS)
- عرض التقارير
- إنشاء تقارير جديدة
- تعديل التقارير
- حذف التقارير
- الموافقة على التقارير
- تصدير التقارير

#### إدارة المشاريع (PROJECTS)
- عرض المشاريع
- إنشاء مشاريع جديدة
- تعديل المشاريع
- حذف المشاريع
- تعيين الموارد

## الإصلاحات التي تم تنفيذها

### 1. إصلاح مشكلة CSRF Token
**المشكلة**: كانت صفحة إدارة الصلاحيات ترسل طلبات POST بدون CSRF token، مما يسبب فشل الطلبات.

**الحل**:
- إضافة دالة `getCSRFToken()` في JavaScript لقراءة CSRF token من meta tag
- إرسال CSRF token في header `X-CSRFToken` مع كل طلب POST
- تحسين معالجة الأخطاء لعرض رسائل خطأ واضحة

### 2. تحسين معالجة الأخطاء
- إضافة try-catch blocks في endpoint `/admin/permissions/update`
- إرجاع JSON responses متسقة مع `success` flag
- تحسين رسائل الخطأ باللغة العربية
- إضافة logging للأخطاء

### 3. تحسين تجربة المستخدم
- إعادة تحميل الصلاحيات تلقائياً بعد الحفظ الناجح
- عرض رسائل واضحة عند النجاح أو الفشل
- مؤشر بصري لعدد التغييرات المعلقة
- زر حفظ يظهر فقط عند وجود تغييرات

## كيفية استخدام النظام

### الخطوات الأساسية:

1. **الدخول إلى إدارة الصلاحيات**
   - افتح صفحة `/admin/permissions/comprehensive`
   - تأكد من تسجيل الدخول كمدير عام

2. **اختيار المشروع**
   - استعرض قائمة المشاريع
   - استخدم البحث للعثور على المشروع المطلوب
   - اضغط على المشروع للمتابعة

3. **اختيار المستخدم**
   - استعرض قائمة المستخدمين المرتبطين بالمشروع
   - استخدم البحث للعثور على المستخدم
   - اضغط على المستخدم للمتابعة

4. **إدارة الصلاحيات**
   - اضغط على رأس القسم لعرض الصلاحيات
   - استخدم المفاتيح لتفعيل/إلغاء الصلاحيات
   - استخدم أزرار "تفعيل الكل" أو "إلغاء الكل" للتحكم السريع
   - راقب مؤشر التغييرات في الأعلى

5. **حفظ التغييرات**
   - اضغط على زر "حفظ التغييرات" الظاهر في الأسفل
   - انتظر رسالة النجاح
   - سيتم إعادة تحميل الصلاحيات تلقائياً

## نقاط API المتاحة

### 1. جلب قائمة المشاريع
```
GET /admin/permissions/projects
```
**الاستجابة**:
```json
{
  "projects": [
    {
      "id": "uuid",
      "name": "اسم المشروع",
      "code": "كود المشروع",
      "status": "حالة المشروع",
      "employees_count": عدد الموظفين
    }
  ]
}
```

### 2. جلب قائمة المستخدمين لمشروع معين
```
GET /admin/permissions/users/<project_id>
```
**الاستجابة**:
```json
{
  "users": [
    {
      "id": "uuid",
      "username": "اسم المستخدم",
      "full_name": "الاسم الكامل",
      "email": "البريد الإلكتروني",
      "role": "الدور",
      "employee_name": "اسم الموظف",
      "employee_id": "رقم الموظف"
    }
  ]
}
```

### 3. جلب مصفوفة الصلاحيات
```
GET /admin/permissions/matrix/<user_id>/<project_id>
```
**الاستجابة**:
```json
{
  "user": {
    "id": "uuid",
    "username": "اسم المستخدم",
    "full_name": "الاسم الكامل"
  },
  "project": {
    "id": "uuid",
    "name": "اسم المشروع",
    "code": "كود المشروع"
  },
  "permissions": [
    {
      "section": "القسم",
      "subsection": "القسم الفرعي",
      "permission_key": "مفتاح الصلاحية",
      "permission_type": "نوع الصلاحية",
      "name_ar": "الاسم بالعربية",
      "name_en": "الاسم بالإنجليزية",
      "is_granted": true/false
    }
  ]
}
```

### 4. تحديث صلاحية واحدة
```
POST /admin/permissions/update
Content-Type: application/json
X-CSRFToken: <token>
```
**البيانات المطلوبة**:
```json
{
  "user_id": "uuid",
  "section": "القسم",
  "subsection": "القسم الفرعي",
  "permission_type": "نوع الصلاحية",
  "is_granted": true/false,
  "project_id": "uuid"
}
```
**الاستجابة**:
```json
{
  "success": true,
  "message": "تم تحديث الصلاحية بنجاح"
}
```

## سجل التدقيق (Audit Log)

يتم تسجيل جميع التغييرات في الصلاحيات في جدول `permission_audit_log` مع المعلومات التالية:
- المستخدم الذي قام بالتغيير
- المستخدم المستهدف
- القسم والقسم الفرعي
- نوع الصلاحية
- القيمة القديمة والجديدة
- المشروع المرتبط
- عنوان IP
- User Agent
- تاريخ ووقت التغيير

## الأمان

### حماية CSRF
- جميع طلبات POST محمية بـ CSRF token
- يتم التحقق من الـ token في كل طلب
- الـ tokens صالحة لمدة ساعة واحدة

### التحقق من الصلاحيات
- جميع endpoints محمية بـ `@login_required`
- endpoints إدارة الصلاحيات محمية بـ `@admin_required`
- يتم التحقق من صلاحيات المستخدم قبل كل عملية

### تسجيل الأحداث
- جميع التغييرات مسجلة في audit log
- يتم حفظ IP address و User Agent
- يمكن مراجعة التغييرات من صفحة `/admin/permissions/audit`

## استكشاف الأخطاء

### مشكلة: رسالة "فشل حفظ التغييرات"
**الحل**:
1. تحقق من اتصال الإنترنت
2. تحقق من صلاحيات المستخدم (يجب أن يكون مدير عام)
3. تحقق من صلاحية الجلسة (قد تحتاج لتسجيل الدخول مرة أخرى)
4. افحص console في المتصفح للأخطاء

### مشكلة: الصفحة لا تحمل المشاريع/المستخدمين
**الحل**:
1. تحقق من اتصال قاعدة البيانات
2. تحقق من وجود مشاريع/مستخدمين في النظام
3. افحص server logs للأخطاء

### مشكلة: CSRF Token خطأ
**الحل**:
1. أعد تحميل الصفحة
2. امسح cache المتصفح
3. تحقق من إعدادات الـ cookies

## المتطلبات التقنية

### Backend:
- Flask
- Flask-Login
- Flask-WTF (CSRF Protection)
- SQLAlchemy

### Frontend:
- Bootstrap 5
- Font Awesome Icons
- JavaScript (ES6+)
- Fetch API

### قاعدة البيانات:
- جدول `user` - معلومات المستخدمين
- جدول `project` - معلومات المشاريع
- جدول `sub_permission` - الصلاحيات الفعلية
- جدول `permission_audit_log` - سجل التدقيق

## التحديثات المستقبلية المقترحة

1. **تصدير الصلاحيات**
   - تصدير صلاحيات مستخدم معين إلى Excel/PDF
   - استيراد الصلاحيات من ملف

2. **القوالب (Templates)**
   - إنشاء قوالب صلاحيات جاهزة
   - تطبيق القالب على مستخدمين متعددين

3. **المقارنة**
   - مقارنة صلاحيات مستخدمين مختلفين
   - عرض الفروقات بشكل بصري

4. **الإشعارات**
   - إشعار المستخدم عند تغيير صلاحياته
   - سجل التغييرات الأخيرة

5. **التقارير**
   - تقرير شامل بجميع الصلاحيات في المشروع
   - تقرير بالمستخدمين الذين لديهم صلاحية معينة

## الخلاصة

نظام إدارة الصلاحيات الشامل يوفر تحكماً كاملاً ومرناً في صلاحيات المستخدمين. التحديثات الأخيرة أصلحت مشكلة CSRF وحسنت تجربة المستخدم بشكل كبير.

للمزيد من المعلومات أو الدعم الفني، يرجى مراجعة:
- [دليل المطور](DEVELOPER_GUIDE.md)
- [دليل API](API_REFERENCE.md)
- [دليل قاعدة البيانات](DATABASE_ERD.md)
